#!/usr/bin/env node

var http = require('http');
var httpProxy = require('http-proxy');
var _ = require('lodash');
var mappings = (function() {
  var internalApps = require('../internal-apps');
  return internalApps(require('../mappings'));
}());

(function() {

  var proxy = httpProxy.createProxyServer({});

  var router = function(req, res) {

    var host = req.headers.host;
    var redirect = _.find(mappings, function(mapping) {
      return _.contains(host, mapping.contains);
    });

    // if none found in mapping, fall back to main site
    if (!redirect) {
      redirect = {
        redirect: 'http://localhost:3000'
      };
    }

    if (_.contains(redirect.redirect, 'localhost')) {
      // route internally
      proxy.web(req, res, { target: redirect.redirect });
    } else {
      // redirect externally
      res.writeHead(301, {'Location': redirect.redirect });
      res.end();
    }
  };

  var port = process.env.PORT || 18080;
  var server = http.createServer(router).listen(port, function() {
    console.log('Listening on port ' + server.address().port);
  });
})();
